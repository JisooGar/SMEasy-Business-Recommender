const barangaySubareas = {
    Baclaran: ["Crystal Ville", "Mabuhay City", "PH 1 Mabuhay City", "Purok 3", "Villa Estella Subdivision", "Blanks"],
    Banaybanay: ["Bamboo Orchard", "Corner Road 1", "Del Rosario Compound", "Don Onofre Village", "Gatchalian Subdivision", "Gatchalian Industrial Estate",
        "Grand Acacia Grove", "Greenleaf Residences", "Hongkong Village", "Katapatan Homes", "Lakeside Nest Subdivision", "National Highway", "NIA Road",
        "San Carlos Village", "Southville 1", "Southpoint Subdivision", "Blanks"
    ],
    Banlic: ["Alimagno Compound", "Camella Homes", "Camella Homes Bermuda", "Dona Ines Compound", "Felicias Compound", "Gran Seville", "Mamatid Road",
        "National Highway", "Palmsville Subdivision", "Prince Village", "Purok 1", "Purok 2", "Purok 3", "Purok 4", "San Isidro Heights", "Tamis Compounds", 
        "Blanks"
    ],
    Bigaa: ["Bella Solana", "Bigaa Road", "Blanks", "Egaland", "Major Homes Subdivision", "Marinig Road", "Purok 1", "Purok 2",
        "Purok 3", "Purok 4", "Purok 5", "Purok 6", "Stoneridge Ville", "Tierra Elsol Subdivision"
    ],
    Butong: ["Blanks", "Purok 1", "Purok 2", "Purok 3", "Purok 4", "Purok 5", "Purok 6", "St. Joseph Village 4", "St. Joseph Village 6", "St. Joseph Village 8"
    ],
    Casile: ["Blanks", "Purok 1", "Purok 3", "Purok 4", "Purok 5", "Purok 6", "Purok Tagaytay Cabuyao"
    ],
    Diezmo: ["Blanks", "Cavitehan Road", "Celestine Ville", "Centerra","New Mahogany Village 3", "NIA Road",
    ],
    Gulod: ["Purok 1", "Purok 2", "Purok 3", "Purok 4", "Purok 5", "Purok 6", "Purok 7", 
        "St. Joseph Homes 1", "St. Joseph Homes 2", "St. Joseph Village 2", "St. Joseph Village 7", "St. Joseph Windfield 2"
    ],
    Mamatid: ["Blanks", "Brillianz Residences", "Buena Rosario", "Ciudad Montrina", "Extraordinary Homes Executive", "Extraordinary Homes Mabuhay", 
          "Luxury Mabuhay City", "Mabuhay City", "Main Road", "Mamatid Road", "Montrina Subdivision", "NIA Road", "Phase 1 Mabuhay", "Phase 2 Mabuhay", 
          "Phase 3 Cluster Mabuhay", "Phase 3 Executive Mabuhay", "Phase 3 Extension Mabuhay", "Phase 3 Mabuhay", "Phase 4 Mabuhay", "Phase 5 Mabuhay", 
          "Phase 6 Mabuhay", "Phase 7 Mabuhay", "Purok 1", "Purok 2", "Purok 3"," Purok 4", "St. Joseph Village 3", "St. Vincent Compound", "Value Homes 1", "Value Homes 2", "Value Homes 3"
    ],
    Marinig: ["Blanks", "Celestine Homes", "Lakeside Nest Subdivision", "Lynville Residences", "Maripaz Ville", 
          "Purok 1", "Purok 2", "Purok 3", "Purok 4", "Purok 5", "Purok 6", "Southville 1", "St. Joesph Village 7", "Sunrise Subdivision"
    ],
    Niugan: ["Blanks", "Console Village", "Hemedez Compound", "National Highway", "NIA Road", "Purok 3", "Regatta South Executive Homes", 
        "Riverside Road", "San Antonio", "SB Hain Compound", "Southville 1", "St. Francis Homes 6"
    ],
    Pittland: ["Blanks", "Camella La vecina Dos Rios", "Hana Garden Villas", "Inc Compound", "Tereley Industrial Park"
    ],
    "Poblacion Uno": ["Bermudez Compound", "Blanks", "JP Rizal St.", "Juan Luna St.", "Limacaoco St.", "Mabini St.", "Malvar St.", "ML Quezon St.", 
        "Osmena St", "P Burgos St.", "Vanessa Compound"
    ],
    "Poblacion Dos": ["A. Bonifacion St.", "Cabuyao Retail Plaza", "El Sol Plaza", "JP Rizal St.", "MH Del Pilar", 
        "ML Quezon St.", "National Highway", "Osmena St."
    ],
    "Poblacion Tres": ["Blanks", "Cemetery Road", "Elso Subdivision", "JP Rizal St.", "Limcaoco Subdivision", "Osmena St.", "Sto. Nino Executive Homes"
    ],
    Pulo: ["Arabelle Homes", "Birmingham Village", "Blanks", "Cabuyao Centrale", "Centennial Homes 2", "Diezmo Road", 
        "Divimall", "Don Vicente Village", "Eastland 2", "Evergreen Subdivision", "Fortezza Subdivision", "Mahogany Promenade",
        "Mahogany Village Ph1", "Millwood Ville", "National Highway", "NIA road", "Paseo de Cabuyao", "Pulo-Diezmo Road", "Pulo-San Isidro Road", "Realica", "Villa Adelinia 2", "Willow Park Homes", "Pulo-Diezmo Road", "Pulo-San Isidro Road", "Realica", "Villa Adelinia 2", "Willow Park Homes"
    ],
    Sala: ["Asia Brewery Compound", "Bagong Silang", "Bella Subdivision", "Blanks", "Casa Esperanza", "Don Onofre Building 2", "Florence Homes", "JP Rizal St.", "La Bella Homes", 
        "Marinig Road", "Mercedez Village", "Multiland III", "National Highway", "Nevalga Farm Drive", "NIA Road", "PFB Bailon St.", "Purok 1", "Purok 2", "Purok 4", "Purok 5", "Rosario Village", "Rotonda", "Shineland"
    ],
    SanIsidro: ["Blanks", "Canaan Homes", "Centennial Plaza", "Centennial Town Homes", "Emmanual SJB Complex", "Fortezza Subdivision", "IFL Compound", "Manila South Road", "National Highway",
        "New Mahogany Village 3", "NIA Road", "Our Mahogany Village 2", "Purok 1", "Purok 2", "Purok 4", "Purok 5", "San Isidro Heights", "San Isidro Homes", "San Isidro Road", 
        "St. Isidore Executive Village", "Tierra Allegra", "Vanessa Homes"
    ],
};


document.getElementById('barangay').addEventListener('change', function () {
  const selectedBarangay = this.value;
  const subareaDropdown = document.getElementById('subarea');

  // Clear current subarea options
  subareaDropdown.innerHTML = '<option value="" selected disabled>Select Subarea</option>';

  // Populate new subareas based on selected barangay
  if (barangaySubareas[selectedBarangay]) {
      barangaySubareas[selectedBarangay].forEach(subarea => {
          const option = document.createElement('option');
          option.value = subarea;
          option.textContent = subarea;
          subareaDropdown.appendChild(option);
      });
  }
});

// Selected business index for editing
let selectedBusinessIndex = null;
let smeData = []; // Declare globally
let inactiveSMEData = []; // Inactive SMEs

// Example admin data (this should come from your backend in a real-world scenario)
const adminData = {
    name: 'Admin 1', // Example name
    id: 'A1',        // Example admin ID
    
};

// Set the initials in the profile display
const profileInitials = document.getElementById('profileInitials');
profileInitials.textContent = adminData.id; // Set to the admin's ID (e.g., "A1")

// Set the greeting in the dropdown menu
const adminGreeting = document.getElementById('adminGreeting');
adminGreeting.textContent = `Hello, ${adminData.name}!`;

// Toggle dropdown visibility
document.getElementById('profileDropdownButton').addEventListener('click', () => {
    const dropdown = document.getElementById('profileDropdownMenu');
    dropdown.classList.toggle('hidden');
});

// Close dropdown when clicking outside
window.addEventListener('click', (e) => {
    const button = document.getElementById('profileDropdownButton');
    const dropdown = document.getElementById('profileDropdownMenu');
    if (!button.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.add('hidden');
    }
}); 

// Show the Change Password modal
document.getElementById('editProfileButton').addEventListener('click', (e) => {
    e.preventDefault();
    const modal = document.getElementById('changePasswordModal');
    if (modal) {
        modal.classList.remove('hidden');
    } else {
        console.error("Change Password modal not found!");
    }
});

// Close the modal
document.getElementById('cancelChangePassword').addEventListener('click', () => {
    const modal = document.getElementById('changePasswordModal');
    if (modal) {
        modal.classList.add('hidden');
    } else {
        console.error("Change Password modal not found!");
    }
});

// Handle Change Password form submission
document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (newPassword !== confirmPassword) {
        alert('New passwords do not match!');
        return;
    }

    try {
        const response = await fetch('/admin/update-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ currentPassword, newPassword }),
        });

        if (response.ok) {
            const data = await response.json();
            alert(data.message || 'Password updated successfully!');
            document.getElementById('changePasswordModal').classList.add('hidden');
            document.getElementById('changePasswordForm').reset();
        } else {
            const data = await response.json();
            alert(data.message || 'Failed to update password.');
        }
    } catch (error) {
        console.error('Error updating password:', error);
        alert('An error occurred. Please try again.');
    }
});

// DOM Elements
const smeDataButton = document.getElementById('smeDataButton');
const surveyDataButton = document.getElementById('surveyDataButton');
const tableBody = document.getElementById('tableBody'); // This must remain in the scrollable div
const searchBar = document.getElementById('searchBar');
const addBusinessButton = document.getElementById('addBusinessButton');
const surveySubButtons = document.getElementById('surveySubButtons');
const preferencesTabButton = document.getElementById('preferencesTabButton');
const marketDemandsTabButton = document.getElementById('marketDemandsTabButton');
const tableHead = document.querySelector("#tableHead"); // Table Head
const addEditBusinessModal = document.getElementById('addEditBusinessModal');
const closeAddEditBusinessModal = document.getElementById('closeAddEditBusinessModal');
const cancelAddEditBusiness = document.getElementById('cancelAddEditBusiness');
const addEditBusinessForm = document.getElementById('addEditBusinessForm');
const smeSubButtons = document.getElementById('smeSubButtons');
const activeTabButton = document.getElementById('activeTabButton');
const inactiveTabButton = document.getElementById('inactiveTabButton');

//SMES DATA

// Fetch SME Data from the API
const fetchSMEData = async () => {
    try {
        const response = await fetch('/api/smes');
        if (!response.ok) throw new Error('Failed to fetch SME data');
        smeData = await response.json(); // Populate the global variable
        renderSMETable(smeData); // Render the initial table
    } catch (error) {
        console.error('Error fetching SME data:', error);
        alert("Failed to fetch SME data. Please try again later.");
    }
};

// Fetch the data on page load
fetchSMEData();

// Edit SME Function
async function editSME(id) {
    try {
        // Fetch the business details by ID
        const response = await fetch(`/api/business/${id}`);
        if (!response.ok) throw new Error("Failed to fetch business details");

        const business = await response.json();

        // Populate the modal with fetched data
        document.getElementById("businessName").value = business.business_name || "";
        document.getElementById("address").value = business.address || "";
        document.getElementById("subarea").value = business.subarea_name || "";
        document.getElementById("barangay").value = business.barangay_name || "";
        document.getElementById("latitude").value = business.latitude || "";
        document.getElementById("longitude").value = business.longitude || "";
        document.getElementById("industry").value = business.sme_type || "";
        document.getElementById("category").value = business.category_name || "";
        document.getElementById("subcategory").value = business.subcategory_name || "";

        // Set `selectedBusinessIndex` to the business ID for updating
        selectedBusinessIndex = id;

        // Show the modal
        addEditBusinessModal.classList.remove("hidden");
    } catch (error) {
        console.error("Error fetching business:", error);
        alert("An error occurred while fetching the business details.");
    }
}

//Deactivate SME
async function deactivateSME(id) {
    const confirmDelete = confirm(`Are you sure you want to mark business ID ${id} as inactive?`);
    if (!confirmDelete) return;

    try {
        const response = await fetch(`/api/business/inactive/${id}`, { method: "PUT" });
        if (response.ok) {
            alert("Business marked as inactive successfully!");

            // Refresh the active businesses table
            fetchActiveBusinesses();
        } else {
            const error = await response.json();
            throw new Error(error.message || "Failed to mark business as inactive.");
        }
    } catch (error) {
        console.error("Error marking business as inactive:", error);
        alert("An error occurred while processing the request. Please try again.");
    }
}

const activateSME = async (id) => {
    if (confirm(`Are you sure you want to activate business with ID ${id}?`)) {
        try {
            const response = await fetch(`/api/business/${id}/activate`, { method: "PUT" });
            if (response.ok) {
                alert("Business activated successfully.");
                fetchInactiveBusinesses().then((data) => renderInactiveSMETable(data)); // Refresh Inactive Table
            } else {
                throw new Error("Failed to activate business.");
            }
        } catch (error) {
            console.error("Error activating business:", error);
        }
    }
};



//Active Businesses
async function fetchActiveBusinesses() {
    try {
        const response = await fetch("/api/business/active");
        const data = await response.json();
        renderActiveSmesTable(data);
    } catch (error) {
        console.error("Error fetching active businesses:", error);
    }
}

//Inactive Businesses
async function fetchInactiveBusinesses() {
    try {
        const response = await fetch("/api/business/inactive");
        const data = await response.json();
        renderInactiveSMETable(data);
    } catch (error) {
        console.error("Error fetching inactive businesses:", error);
    }
}

//SME DATA Actions

smeDataButton.addEventListener("click", () => {
    console.log("SME Data Button Clicked");
    fetchSMEData();
});

// Show Add/Edit Business Modal
addBusinessButton.addEventListener("click", () => {
    addEditBusinessForm.reset(); // Reset the form
    selectedBusinessIndex = null; // Clear selected index for new business
    addEditBusinessModal.classList.remove("hidden"); // Show modal
});

// document.getElementById("activeTabButton").addEventListener("click", () => {
//     fetchSMEData().then((data) => renderSMETable(data));
// });

// document.getElementById("inactiveTabButton").addEventListener("click", () => {
//     fetchSMEData().then((data) => renderInactiveSMETable(data));
// });

activeTabButton.addEventListener("click", () => {
    activeTabButton.classList.add("bg-green-500", "text-white");
    inactiveTabButton.classList.remove("bg-green-500", "text-white");

    fetchActiveBusinesses().then((activeData) => renderSMETable(activeData));
});

inactiveTabButton.addEventListener("click", () => {
    inactiveTabButton.classList.add("bg-green-500", "text-white");
    activeTabButton.classList.remove("bg-green-500", "text-white");

    fetchInactiveBusinesses().then((inactiveData) => renderInactiveSMETable(inactiveData));
});


// Ensure SME Sub Buttons and Active tab are visible by default
document.addEventListener("DOMContentLoaded", () => {
    // Highlight SME Data button
    smeDataButton.classList.add("bg-orange-500", "text-white");
    surveyDataButton.classList.add("bg-gray-200", "text-gray-800");

    // Highlight Active tab as the default
    activeTabButton.classList.add("bg-green-500", "text-white");
    inactiveTabButton.classList.remove("bg-green-500", "text-white");

    // Show SME Sub Buttons (Active/Inactive)
    smeSubButtons.classList.remove("hidden");

    // Show Search Bar and Add Business Button
    searchBar.classList.remove("hidden");
    addBusinessButton.classList.remove("hidden");

    // Hide Survey Sub Buttons (Preferences/Market Demands)
    surveySubButtons.classList.add("hidden");

    // Render SME Data Table (Active)
    fetchSMEData(); // Fetch and render Active SMEs
});

// Handle SME Data Button Click
smeDataButton.addEventListener("click", () => {
    // Highlight SME Data button
    smeDataButton.classList.add("bg-orange-500", "text-white");
    surveyDataButton.classList.remove("bg-orange-500", "text-white");
    surveyDataButton.classList.add("bg-gray-200", "text-gray-800");

    // Show SME Sub Buttons (Active/Inactive)
    smeSubButtons.classList.remove("hidden");

    // Show the Search Bar and Add Business Button
    searchBar.classList.remove("hidden");
    addBusinessButton.classList.remove("hidden");

    // Hide Survey Sub Buttons (Preferences/Market Demands)
    surveySubButtons.classList.add("hidden");

    // Default to Active tab
    activeTabButton.click();
});

// Handle Active Button Click
activeTabButton.addEventListener("click", () => {
    // Highlight Active tab
    activeTabButton.classList.add("bg-green-500", "text-white");
    inactiveTabButton.classList.remove("bg-green-500", "text-white");

    // Fetch and render Active SME Data
    fetchSMEData(); // Assuming this fetches only active SME data
});

// Attach event listener for the Inactive button
inactiveTabButton.addEventListener("click", () => {
    // Highlight Inactive tab
    inactiveTabButton.classList.add("bg-green-500", "text-white");
    activeTabButton.classList.remove("bg-green-500", "text-white");

    // Fetch and render the inactive SME table
    fetchInactiveSMETable();
});

// Close Modal
const closeModal = () => addEditBusinessModal.classList.add("hidden");
closeAddEditBusinessModal.addEventListener("click", closeModal);
cancelAddEditBusiness.addEventListener("click", closeModal);


addEditBusinessForm.addEventListener("submit", async (e) => {
    e.preventDefault(); // Prevent default form submission behavior

    const business = {
        name: document.getElementById("businessName").value.trim(),
        address: document.getElementById("address").value.trim(),
        subarea: document.getElementById("subarea").value.trim(),
        barangay: document.getElementById("barangay").value.trim(),
        latitude: document.getElementById("latitude").value.trim(),
        longitude: document.getElementById("longitude").value.trim(),
        industry: document.getElementById("industry").value.trim(),
        category: document.getElementById("category").value.trim(),
        subcategory: document.getElementById("subcategory").value.trim(),
    };

    try {
        if (selectedBusinessIndex) {
            // Edit existing business
            const response = await fetch(`/api/business/${selectedBusinessIndex}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(business),
            });

            if (response.ok) {
                const data = await response.json();
                alert(data.message || "Business updated successfully!");
                await fetchSMEData(); // Refresh table
                closeModal(); // Close modal
                selectedBusinessIndex = null; // Reset selected index
            } else {
                const error = await response.json();
                throw new Error(error.message || "Failed to update business.");
            }
        } else {
            // Add a new business
            const response = await fetch("/api/business", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(business),
            });

            if (response.ok) {
                const data = await response.json();
                alert(data.message || "Business added successfully!");
                await fetchSMEData(); // Refresh table
                addEditBusinessForm.reset(); // Clear form
                closeModal(); // Close modal
            } else {
                const error = await response.json();
                throw new Error(error.message || "Failed to add business.");
            }
        }
    } catch (error) {
        console.error("Error processing business:", error);
        alert("An error occurred while processing the business. Please try again.");
    }
});

//Render SME Table (Active)
const renderSMETable = (data) => {
    tableHead.innerHTML = `
        <tr>
            <th class="px-4 py-2">ID</th>
            <th class="px-4 py-2">Name</th>
            <th class="px-4 py-2">Address</th>
            <th class="px-4 py-2">Barangay</th>
            <th class="px-4 py-2">Subarea</th>
            <th class="px-4 py-2">Latitude</th>
            <th class="px-4 py-2">Longitude</th>
            <th class="px-4 py-2">SME Type</th>
            <th class="px-4 py-2">Category</th>
            <th class="px-4 py-2">Subcategory</th>
            <th class="px-4 py-2">Actions</th>
        </tr>
    `;

    tableBody.innerHTML = ""; // Clear existing rows

    data.filter((item) => item.status === "Active").forEach((item) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td class="px-4 py-2">${item.business_id}</td>
            <td class="px-4 py-2">${item.business_name}</td>
            <td class="px-4 py-2">${item.address || "N/A"}</td>
            <td class="px-4 py-2">${item.barangay_name || "N/A"}</td>
            <td class="px-4 py-2">${item.subarea_name || "N/A"}</td>
            <td class="px-4 py-2">${item.latitude || "N/A"}</td>
            <td class="px-4 py-2">${item.longitude || "N/A"}</td>
            <td class="px-4 py-2">${item.sme_type || "N/A"}</td>
            <td class="px-4 py-2">${item.category_name || "N/A"}</td>
            <td class="px-4 py-2">${item.subcategory_name || "N/A"}</td>
            <td class="px-4 py-2">
                <button class="edit-button text-blue-500 hover:underline" data-id="${item.business_id}">Edit</button>
                <button class="deactivate-button text-red-500 hover:underline" data-id="${item.business_id}">Deactivate</button>
            </td>
        `;
        tableBody.appendChild(row);
    });
};

//Function to render the inactive SME table
const renderInactiveSMETable = (data) => {
    tableHead.innerHTML = `
        <tr>
            <th class="px-4 py-2">ID</th>
            <th class="px-4 py-2">Name</th>
            <th class="px-4 py-2">Address</th>
            <th class="px-4 py-2">Barangay</th>
            <th class="px-4 py-2">Subarea</th>
            <th class="px-4 py-2">Latitude</th>
            <th class="px-4 py-2">Longitude</th>
            <th class="px-4 py-2">SME Type</th>
            <th class="px-4 py-2">Category</th>
            <th class="px-4 py-2">Subcategory</th>
            <th class="px-4 py-2">Actions</th>
        </tr>
    `;

    tableBody.innerHTML = ""; // Clear existing rows

    data.filter((item) => item.status === "Inactive").forEach((item) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td class="px-4 py-2">${item.business_id}</td>
            <td class="px-4 py-2">${item.business_name}</td>
            <td class="px-4 py-2">${item.address || "N/A"}</td>
            <td class="px-4 py-2">${item.barangay_name || "N/A"}</td>
            <td class="px-4 py-2">${item.subarea_name || "N/A"}</td>
            <td class="px-4 py-2">${item.latitude || "N/A"}</td>
            <td class="px-4 py-2">${item.longitude || "N/A"}</td>
            <td class="px-4 py-2">${item.sme_type || "N/A"}</td>
            <td class="px-4 py-2">${item.category_name || "N/A"}</td>
            <td class="px-4 py-2">${item.subcategory_name || "N/A"}</td>
            <td class="px-4 py-2">
                <button class="edit-button text-blue-500 hover:underline" data-id="${item.business_id}">Edit</button>
                <button class="activate-button text-green-500 hover:underline" data-id="${item.business_id}">Activate</button>
            </td>
        `;
        tableBody.appendChild(row);
    });
};




// SURVEY

surveyDataButton.addEventListener("click", () => {
    // Highlight Survey Data button
    surveyDataButton.classList.add("bg-orange-500", "text-white");
    smeDataButton.classList.remove("bg-orange-500", "text-white");
    smeDataButton.classList.add("bg-gray-200", "text-gray-800");

    // Show sub-buttons for Preferences and Market Demands
    surveySubButtons.classList.remove("hidden");

    // Clear the table and show loading placeholder
    tableHead.innerHTML = '<tr><td colspan="22" class="text-center text-gray-500">Loading...</td></tr>';
    tableBody.innerHTML = '';

    // Default to Preferences tab
    preferencesTabButton.click();
});


// Preferences Button Event Listener
preferencesTabButton.addEventListener("click", async () => { // Add 'async' here
// Update button states
preferencesTabButton.classList.add("bg-green-500", "text-white");
marketDemandsTabButton.classList.remove("bg-green-500", "text-white");

// Clear the table and show loading placeholder
tableHead.innerHTML = '<tr><td colspan="22" class="text-center text-gray-500">Loading Preferences...</td></tr>';
tableBody.innerHTML = '';

// Fetch and render Preferences data
await fetchPreferencesData(); // Ensure this is awaited
});


// Market Demands Button Event Listener
marketDemandsTabButton.addEventListener("click", async () => { // Add 'async' here
// Update button states
marketDemandsTabButton.classList.add("bg-green-500", "text-white");
preferencesTabButton.classList.remove("bg-green-500", "text-white");

// Clear the table and show loading placeholder
tableHead.innerHTML = '<tr><td colspan="19" class="text-center text-gray-500">Loading Market Demands...</td></tr>';
tableBody.innerHTML = '';

// Fetch and render Market Demands data
await fetchMarketDemandsData(); // Ensure this is awaited
});



// Fetch Preferences Data
const fetchPreferencesData = async () => {
    try {
        const response = await fetch("/api/preferences");
        if (!response.ok) throw new Error("Failed to fetch Preferences data");
        const data = await response.json();
        renderPreferencesTable(data); // Render the Preferences table
    } catch (err) {
        console.error("Error fetching Preferences data:", err);
    }
};

// Fetch Market Demands Data
const fetchMarketDemandsData = async () => {
    try {
        const response = await fetch("/api/market-demands");
        if (!response.ok) throw new Error("Failed to fetch Market Demands data");
        const data = await response.json();
        renderMarketDemandsTable(data); // Render the Market Demands table
    } catch (err) {
        console.error("Error fetching Market Demands data:", err);
    }
};


async function deleteSurvey(id) {
    const userConfirmed = confirm(`Are you sure you want to delete the survey with ID ${id}? This action cannot be undone.`);
    if (!userConfirmed) return; // Exit if user cancels

    try {
        const response = await fetch(`/api/survey/${id}`, { method: "DELETE" });

        if (response.ok) {
            alert("Survey deleted successfully!");
                // Check which table is currently active and refresh it
                const isPreferencesActive = preferencesTabButton.classList.contains("bg-green-500"); // Adjust based on your active state logic
                if (isPreferencesActive) {
                    await fetchPreferencesData(); // Refresh Preferences table
                } else {
                    await fetchMarketDemandsData(); // Refresh Market Demands table
                }
        } else if (response.status === 404) {
            alert(`Survey with ID ${id} was not found. It may have already been deleted.`);
        } else {
            const error = await response.json();
            throw new Error(error.message || "Failed to delete survey.");
        }
    } catch (error) {
        console.error("Error deleting survey:", error);
        alert("An error occurred while deleting the survey. Please try again.");
    }
}

// Handle Survey Data Button Click
surveyDataButton.addEventListener("click", () => {
    // Highlight Survey Data button
    surveyDataButton.classList.add("bg-orange-500", "text-white");
    smeDataButton.classList.remove("bg-orange-500", "text-white");
    smeDataButton.classList.add("bg-gray-200", "text-gray-800");

    // Hide SME Sub Buttons (Active/Inactive)
    smeSubButtons.classList.add("hidden");

    // Hide the Search Bar and Add Business Button
    searchBar.classList.add("hidden");
    addBusinessButton.classList.add("hidden");

    // Show Survey Sub Buttons (Preferences/Market Demands)
    surveySubButtons.classList.remove("hidden");

    // Default to Preferences tab
    preferencesTabButton.click();
});


const renderSurveyTable = (data) => {
    tableBody.innerHTML = ''; // Clear existing rows
    data.forEach((item) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-4 py-2">${item.id}</td>
            <td class="px-4 py-2">${item.name}</td>
            <td class="px-4 py-2">${item.address}</td>
            <td class="px-4 py-2">${item.subarea}</td>
            <td class="px-4 py-2">${item.barangay}</td>
            <td class="px-4 py-2">${item.latitude}</td>
            <td class="px-4 py-2">${item.longitude}</td>
            <td class="px-4 py-2">${item.industry || 'N/A'}</td>
            <td class="px-4 py-2">${item.category || 'N/A'}</td>
            <td class="px-4 py-2">${item.subcategory || 'N/A'}</td>
            <td class="px-4 py-2">
                <button class="delete-button text-red-500 hover:underline" data-id="${item.id}">Delete</button>
            </td>
        `;
        tableBody.appendChild(row);
    });
};



// Render Preferences Table
const renderPreferencesTable = (data) => {

    // Update Table Headers
    tableHead.innerHTML = `
        <tr>
            <th>ID</th>
            <th>Month</th>
            <th>Barangay</th>
            <th>Age Range</th>
            <th>Gender</th>
            <th>Education</th>
            <th>Employment</th>
            <th>Business Visits</th>
            <th>Frequent Visits</th>
            <th>Browsing Behavior</th>
            <th>Satisfaction</th>
            <th>Lacking</th>
            <th>Shopping Preference</th>
            <th>Motivation for Choosing</th>
            <th>Shopping Traits</th>
            <th>Factors for New Businesses</th>
            <th>Shopping Style</th>
            <th>Values</th>
            <th>Transportation Links</th>
            <th>Accessibility</th>
            <th>Outside Barangay Travel</th>
            <th>Transportation Challenges</th>
            <th>Actions</th>
        </tr>
    `;

    // Update Table Body
    tableBody.innerHTML = "";
    data.forEach((item) => {
        const row = `
            <tr>
                <td>${item.id}</td>
                <td>${item.month}</td>
                <td>${item.barangay}</td>
                <td>${item.ageRange}</td>
                <td>${item.gender}</td>
                <td>${item.education}</td>
                <td>${item.employment}</td>
                <td>${item.businessVisits}</td>
                <td>${item.frequentVisits}</td>
                <td>${item.browsingBehavior}</td>
                <td>${item.satisfaction}</td>
                <td>${item.lacking}</td>
                <td>${item.shoppingPreference}</td>
                <td>${item.motivationForChoosing}</td>
                <td>${item.shoppingTraits}</td>
                <td>${item.factorsForNewBusinesses}</td>
                <td>${item.shoppingStyle}</td>
                <td>${item.values}</td>
                <td>${item.transportationLinks}</td>
                <td>${item.accessibility}</td>
                <td>${item.outsideBarangayTravel}</td>
                <td>${item.transportationChallenges}</td>
                <td class="px-4 py-2">
                <button class="surveypdelete-button text-red-500 hover:underline" surveydata-id="${item.id}">Delete</button>
            </td>
            </tr>
        `;
        tableBody.innerHTML += row;
    });
};

// Render Market Demands Table
const renderMarketDemandsTable = (data) => {

    // Update Table Headers
    tableHead.innerHTML = `
        <tr>
            <th>ID</th>
            <th>Barangay</th>
            <th>Automotive Services</th>
            <th>Construction</th>
            <th>Cooperative Business</th>
            <th>Creative Media</th>
            <th>Education Services</th>
            <th>Entertainment</th>
            <th>Finance and Insurance</th>
            <th>Food Services</th>
            <th>Healthcare Services</th>
            <th>IT Services</th>
            <th>Manufacturing</th>
            <th>Personal Services</th>
            <th>Professional Services</th>
            <th>Retail Stores</th>
            <th>Tourism and Hospitality</th>
            <th>Transportation</th>
            <th>Wholesale</th>
            <th>Actions</th>
        </tr>
    `;

    // Update Table Body
    tableBody.innerHTML = "";
    data.forEach((item) => {
        const row = `
            <tr>
                <td>${item.id}</td>
                <td>${item.barangay}</td>
                <td>${item.automotive}</td>
                <td>${item.construction}</td>
                <td>${item.cooperativeBusiness}</td>
                <td>${item.creativeMedia}</td>
                <td>${item.educationServices}</td>
                <td>${item.entertainment}</td>
                <td>${item.financeInsurance}</td>
                <td>${item.foodServices}</td>
                <td>${item.healthcare}</td>
                <td>${item.itDigital}</td>
                <td>${item.manufacturing}</td>
                <td>${item.personalHousehold}</td>
                <td>${item.professionalServices}</td>
                <td>${item.retail}</td>
                <td>${item.tourismHospitality}</td>
                <td>${item.transportation}</td>
                <td>${item.wholesale}</td>
                            <td class="px-4 py-2">
                <button class="surveymddelete-button text-red-500 hover:underline" surveydata-id="${item.id}">Delete</button>
            </td>
            </tr>
        `;
        tableBody.innerHTML += row;
    });
};

//BOTH

tableBody.addEventListener("click", (e) => {
    const target = e.target;

    // Handle Edit Button
    if (target.classList.contains("edit-button")) {
        const businessId = target.getAttribute("data-id");
        editSME(businessId);
    }

    // Handle Delete Button
    if (target.classList.contains("delete-button")) {
        const businessId = target.getAttribute("data-id");
        deactivateSME(businessId);
    }
    if (target.classList.contains("surveymddelete-button")) {
        const surveyId = target.getAttribute("surveydata-id");
        deleteSurvey(surveyId);
    }

    if (target.classList.contains("surveypdelete-button")) {
        const surveyId = target.getAttribute("surveydata-id");
        deleteSurvey(surveyId);
    }
});


// Attach Edit and Delete Button Handlers
function attachActionHandlers(data) {
    // Attach Edit Handlers
    document.querySelectorAll(".edit-button").forEach((button) => {
        button.addEventListener("click", async () => {
            const id = button.dataset.id;
            await editSME(id); // Call edit function
        });
    });

    // Attach Deactivate Handlers
    document.querySelectorAll(".deactivate-button").forEach((button) => {
        button.addEventListener("click", async () => {
            const id = button.dataset.id;
            await deactivateSME(id); // Call delete function
        });
    });

    // Attach Delete Handlers
    document.querySelectorAll(".surveymddelete-button").forEach((button) => {
        button.addEventListener("click", async () => {
            const id = button.dataset.id;
            await deleteSurvey(id); // Call delete function
        });
    });

    // Attach Delete Handlers
    document.querySelectorAll(".surveypdelete-button").forEach((button) => {
        button.addEventListener("click", async () => {
            const id = button.dataset.id;
            await deleteSurvey(id); // Call delete function
        });
    });

}

function renderGridTable(data) {
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = ''; // Clear existing rows

    data.forEach((sme) => {
        const rowHTML = `
            <div>${sme.business_id}</div>
            <div>${sme.business_name}</div>
            <div>${sme.address}</div>
            <div>${sme.subarea_name || 'N/A'}</div>
            <div>${sme.barangay_name || 'N/A'}</div>
            <div>${sme.latitude || 'N/A'}</div>
            <div>${sme.longitude || 'N/A'}</div>
            <div>${sme.sme_type || 'N/A'}</div>
            <div>${sme.category_name || 'N/A'}</div>
            <div>${sme.subcategory_name || 'N/A'}</div>
            <div>
                <button class="text-blue-500 hover:underline">Edit</button>
                <button class="text-red-500 hover:underline">Delete</button>
            </div>
        `;
        tableBody.innerHTML += rowHTML;
    });
}


const attachDeactivateHandlers = (data, renderFunction) => {
    document.querySelectorAll(".deactivate-button").forEach((button) => {
        button.addEventListener("click", async () => {
            const id = button.dataset.id;
            if (confirm(`Are you sure you want to deactivate business with ID ${id}?`)) {
                try {
                    const response = await fetch(`/api/business/${id}/deactivate`, { method: "PUT" });
                    if (response.ok) {
                        alert("Business deactivated successfully.");
                        await fetchActiveBusinesses(); // Refresh Active Businesses
                        renderFunction(data);
                    } else {
                        throw new Error("Failed to deactivate business.");
                    }
                } catch (error) {
                    console.error("Error deactivating business:", error);
                }
            }
        });
    });
};

const attachActivateHandlers = (data, renderFunction) => {
    document.querySelectorAll(".activate-button").forEach((button) => {
        button.addEventListener("click", async () => {
            const id = button.dataset.id;
            if (confirm(`Are you sure you want to activate business with ID ${id}?`)) {
                try {
                    const response = await fetch(`/api/business/${id}/activate`, { method: "PUT" });
                    if (response.ok) {
                        alert("Business activated successfully.");
                        await fetchInactiveBusinesses(); // Refresh Inactive Businesses
                        renderFunction(data);
                    } else {
                        throw new Error("Failed to activate business.");
                    }
                } catch (error) {
                    console.error("Error activating business:", error);
                }
            }
        });
    });
};


// Add search functionality
searchBar.addEventListener("input", () => {
    const searchTerm = searchBar.value.trim().toLowerCase(); // Normalize search term
    if (!searchTerm) {
        renderSMETable(smeData); // If search is empty, render the full table
        return;
    }

    // Filter data based on the search term
    const filteredData = smeData.filter((item) => {
        return (
            item.business_name?.toLowerCase().includes(searchTerm) || // Match business name
            item.address?.toLowerCase().includes(searchTerm) || // Match address
            item.barangay_name?.toLowerCase().includes(searchTerm) || // Match barangay
            item.subarea_name?.toLowerCase().includes(searchTerm) || // Match subarea
            item.business_id?.toString().includes(searchTerm) // Match ID
        );
    });

    // Render the filtered table or show a message for no results
    if (filteredData.length > 0) {
        renderSMETable(filteredData);
    } else {
        tableBody.innerHTML = `<tr><td colspan="11" class="text-center text-gray-500">No results found for "${searchTerm}"</td></tr>`;
    }
});



// Handle Edit and Delete Button Click
tableBody.addEventListener('click', (e) => {
    const row = e.target.closest('tr'); // Get the row element
    if (!row) return;

    const id = parseInt(row.children[0].textContent, 10); // Get the ID from the first cell

    // Handle Edit Button Click (Only for SME Data)
    if (e.target.classList.contains('text-blue-500') && smeDataButton.classList.contains('bg-orange-500')) {
        const dataToEdit = smeData.find((business) => business.id === id);

        if (dataToEdit) {
            // Populate the form fields with the existing data
            document.getElementById('businessName').value = dataToEdit.name;
            document.getElementById('address').value = dataToEdit.address;
            document.getElementById('subarea').value = dataToEdit.subarea;
            document.getElementById('barangay').value = dataToEdit.barangay;
            document.getElementById('latitude').value = dataToEdit.latitude;
            document.getElementById('longitude').value = dataToEdit.longitude;
            document.getElementById('industry').value = dataToEdit.industry || '';
            document.getElementById('category').value = dataToEdit.category || '';
            document.getElementById('subcategory').value = dataToEdit.subcategory || '';

            // Set the selected index for updating
            selectedBusinessIndex = smeData.findIndex((business) => business.id === id);

            // Show the modal
            addEditBusinessModal.classList.remove('hidden');
        }
    }
});